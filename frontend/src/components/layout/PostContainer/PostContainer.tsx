import {useEffect, useState} from "react"
import './postContainer.css'
import PostCard from "../PostCard/PostCard";
import {useAlert, useApi} from "@gear-js/react-hooks";
import {ProgramMetadata} from "@gear-js/api";
import {AnyJson} from "@polkadot/types/types";


function PostContainer() {
	const { api } = useApi();
	const [threadState, setThreadState] = useState<ThreadState>();
	const alert = useAlert();

	type ThreadState = {
		id: string,
		owner: string,
		threadType: string,
		title: string,
		content: string,
		replies: [],
		participants: [],
		state: string,
		distributedTokens: number
	}

	// TODO: Get these variables from env file
	const programIDThread = "0xfa43aac2bf08247096ade22dcf5f35a29d9ff0ffa1a484196cda2020e5eda6a1";
	const meta = "0001000100000000000104000000010900000000000000010a000000f90c40000808696f18496e69744654000004013466745f70726f6772616d5f696404011c4163746f72496400000410106773746418636f6d6d6f6e287072696d6974697665731c4163746f724964000004000801205b75383b2033325d000008000003200000000c000c0000050300100808696f30546872656164416374696f6e000110244e65775468726561640400140128496e697454687265616400000024456e64546872656164000100204164645265706c7904001c012c5468726561645265706c79000200244c696b655265706c7904002001107531323800030000140808696f28496e697454687265616400001001086964180118537472696e6700012c7468726561645f74797065180118537472696e670001147469746c65180118537472696e6700011c636f6e74656e74180118537472696e6700001800000502001c0808696f2c5468726561645265706c79000014011c706f73745f696420011075313238000128706f73745f6f776e657204011c4163746f72496400011c636f6e74656e74180118537472696e6700013c6e756d6265725f6f665f6c696b6573200110753132380001446e756d6265725f6f665f7265706f727473200110753132380000200000050700240808696f2c5468726561644576656e7400010c2c546872656164456e646564000000285265706c794164646564000100285265706c794c696b656400020000280808696f20496f54687265616400002401086964180118537472696e670001146f776e657204011c4163746f72496400012c7468726561645f74797065180118537472696e670001147469746c65180118537472696e6700011c636f6e74656e74180118537472696e6700011c7265706c6965732c016c5665633c284163746f7249642c205468726561645265706c79293e0001307061727469636970616e74733401505665633c284163746f7249642c2075313238293e00011473746174653c012c546872656164537461746500014864697374726962757465645f746f6b656e732001107531323800002c00000230003000000408041c0034000002380038000004080420003c0808696f2c5468726561645374617465000108184163746976650000001c4578706972656400010000";

	const metadata = ProgramMetadata.from(meta);
	const getState = () => {
		api.programState
			.read({ programId: programIDThread, payload: ""}, metadata)
			.then((result) => {
				setThreadState((result.toJSON() as unknown as ThreadState));
				alert.success("Successful state");
			})
			.catch(({ message }: Error) => alert.error(message));
	};

	useEffect(() => {
		getState();
	}, []);

	return (
		<div className="postContainer">
			<PostCard title={threadState?.title || ""}
			          content={threadState?.content || ""}
			          type={threadState?.threadType === "Challenge" ? 0 : 1}/>
		</div>
	)
}

// eslint-disable-next-line import/no-default-export
export default PostContainer;